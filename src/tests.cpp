#include "tests.h"
#include <Arduino.h>
#include <Adafruit_ST7789.h>
#include <stdio.h>
#include <string.h>

// The test coordinates and logic were moved here from main.cpp
static const double bp1_test_coords[][4] = {
    {28.070792, -16.705132, 61.9, 6},
    {28.070792, -16.705132, 61.9, 6},
    {28.070792, -16.705132, 61.9, 6},
    {28.070792, -16.705132, 61.9, 6},
    {28.070792, -16.705096, 61.9, 6},
    {28.070792, -16.705096, 61.9, 6},
    {28.070792, -16.705096, 61.9, 6},
    {28.070792, -16.705096, 61.9, 6},
    {28.070791, -16.705061, 61.5, 6},
    {28.070791, -16.705061, 61.5, 6},
    {28.070791, -16.705061, 61.5, 6},
    {28.070791, -16.705061, 61.5, 6},
    {28.070790, -16.705026, 61.7, 6},
    {28.070790, -16.705026, 61.7, 6},
    {28.070790, -16.705026, 61.7, 6},
    {28.070790, -16.705026, 61.7, 6},
    {28.070790, -16.705026, 61.7, 6},
    {28.070789, -16.704991, 61.4, 6},
    {28.070789, -16.704991, 61.4, 6},
    {28.070789, -16.704991, 61.4, 6},
    {28.070789, -16.704991, 61.4, 6},
    {28.070788, -16.704957, 61.1, 6},
    {28.070788, -16.704957, 61.1, 6},
    {28.070788, -16.704957, 61.1, 6},
    {28.070788, -16.704957, 61.1, 6},
    {28.070788, -16.704957, 61.1, 6},
    {28.070787, -16.704923, 60.7, 6},
    {28.070787, -16.704923, 60.7, 6},
    {28.070787, -16.704923, 60.7, 6},
    {28.070787, -16.704923, 60.7, 6},
    {28.070784, -16.704889, 60.4, 6},
    {28.070784, -16.704889, 60.4, 6},
    {28.070784, -16.704889, 60.4, 6},
    {28.070784, -16.704889, 60.4, 6},
    {28.070784, -16.704889, 60.4, 6},
    {28.070781, -16.704855, 60.2, 6},
    {28.070781, -16.704855, 60.2, 6},
    {28.070781, -16.704855, 60.2, 6},
    {28.070781, -16.704855, 60.2, 6},
    {28.070778, -16.704821, 59.9, 6},
    {28.070778, -16.704821, 59.9, 6},
    {28.070778, -16.704821, 59.9, 6},
    {28.070778, -16.704821, 59.9, 6},
    {28.070774, -16.704787, 59.8, 6},
    {28.070774, -16.704787, 59.8, 6},
    {28.070774, -16.704787, 59.8, 6},
    {28.070774, -16.704787, 59.8, 6},
    {28.070774, -16.704787, 59.8, 6},
    {28.070771, -16.704754, 59.3, 6},
    {28.070771, -16.704754, 59.3, 6},
    {28.070771, -16.704754, 59.3, 6},
    {28.070771, -16.704754, 59.3, 6},
    {28.070767, -16.704721, 59.2, 6},
    {28.070767, -16.704721, 59.2, 6},
    {28.070767, -16.704721, 59.2, 6},
    {28.070767, -16.704721, 59.2, 6},
    {28.070767, -16.704721, 59.2, 6},
    {28.070763, -16.704688, 58.8, 6},
    {28.070763, -16.704688, 58.8, 6},
    {28.070763, -16.704688, 58.8, 6},
    {28.070763, -16.704688, 58.8, 6},
    {28.070759, -16.704655, 58.4, 6},
    {28.070759, -16.704655, 58.4, 6},
    {28.070759, -16.704655, 58.4, 6},
    {28.070759, -16.704655, 58.4, 6},
    {28.070759, -16.704655, 58.4, 6},
    {28.070754, -16.704622, 58.4, 6},
    {28.070754, -16.704622, 58.4, 6},
    {28.070754, -16.704622, 58.4, 6},
    {28.070754, -16.704622, 58.4, 6},
    {28.070750, -16.704589, 58.0, 6},
    {28.070750, -16.704589, 58.0, 6},
    {28.070750, -16.704589, 58.0, 6},
    {28.070750, -16.704589, 58.0, 6},
    {28.070750, -16.704589, 58.0, 6},
    {28.070745, -16.704556, 58.1, 6},
    {28.070745, -16.704556, 58.1, 6},
    {28.070745, -16.704556, 58.1, 6},
    {28.070745, -16.704556, 58.1, 6},
    {28.070740, -16.704524, 57.9, 6},
    {28.070740, -16.704524, 57.9, 5},
    {28.070740, -16.704524, 57.9, 5},
    {28.070740, -16.704524, 57.9, 5},
    {28.070735, -16.704492, 58.1, 5},
    {28.070735, -16.704492, 58.1, 5},
    {28.070735, -16.704492, 58.1, 5},
    {28.070735, -16.704492, 58.1, 5},
    {28.070735, -16.704492, 58.1, 5},
    {28.070729, -16.704459, 58.5, 5},
    {28.070729, -16.704459, 58.5, 6},
    {28.070729, -16.704459, 58.5, 6},
    {28.070729, -16.704459, 58.5, 6},
    {28.070723, -16.704426, 58.5, 6},
    {28.070723, -16.704426, 58.5, 6},
    {28.070723, -16.704426, 58.5, 6},
    {28.070723, -16.704426, 58.5, 6},
    {28.070723, -16.704426, 58.5, 6},
    {28.070717, -16.704394, 58.2, 6},
    {28.070717, -16.704394, 58.2, 6},
    {28.070717, -16.704394, 58.2, 6},
    {28.070717, -16.704394, 58.2, 6},
    {28.070711, -16.704362, 58.0, 6},
    {28.070711, -16.704362, 58.0, 6},
    {28.070711, -16.704362, 58.0, 6},
    {28.070711, -16.704362, 58.0, 6},
    {28.070711, -16.704362, 58.0, 6},
    {28.070704, -16.704329, 58.5, 6},
    {28.070704, -16.704329, 58.5, 6},
    {28.070704, -16.704329, 58.5, 6},
    {28.070704, -16.704329, 58.5, 6},
    {28.070698, -16.704297, 58.6, 6},
    {28.070698, -16.704297, 58.6, 6},
    {28.070698, -16.704297, 58.6, 6},
    {28.070698, -16.704297, 58.6, 6},
    {28.070692, -16.704265, 58.3, 6},
    {28.070692, -16.704265, 58.3, 6},
    {28.070692, -16.704265, 58.3, 6},
    {28.070692, -16.704265, 58.3, 6},
    {28.070692, -16.704265, 58.3, 6},
    {28.070685, -16.704232, 58.6, 6},
    {28.070685, -16.704232, 58.6, 6},
    {28.070685, -16.704232, 58.6, 6},
    {28.070685, -16.704232, 58.6, 6},
    {28.070678, -16.704200, 58.3, 6},
    {28.070678, -16.704200, 58.3, 6},
    {28.070678, -16.704200, 58.3, 6},
    {28.070678, -16.704200, 58.3, 6},
    {28.070678, -16.704200, 58.3, 6},
    {28.070672, -16.704168, 58.6, 6},
    {28.070672, -16.704168, 58.6, 6},
    {28.070672, -16.704168, 58.6, 6},
    {28.070672, -16.704168, 58.6, 6},
    {28.070665, -16.704135, 58.9, 6},
    {28.070665, -16.704135, 58.9, 6},
    {28.070665, -16.704135, 58.9, 6},
    {28.070665, -16.704135, 58.9, 6},
    {28.070665, -16.704135, 58.9, 6},
    {28.070658, -16.704102, 59.0, 6},
    {28.070658, -16.704102, 59.0, 6},
    {28.070658, -16.704102, 59.0, 6},
    {28.070658, -16.704102, 59.0, 6},
    {28.070652, -16.704069, 58.9, 6},
    {28.070652, -16.704069, 58.9, 6},
    {28.070652, -16.704069, 58.9, 6},
    {28.070652, -16.704069, 58.9, 6},
    {28.070652, -16.704069, 58.9, 6},
    {28.070645, -16.704036, 59.3, 6},
    {28.070645, -16.704036, 59.3, 6},
    {28.070645, -16.704036, 59.3, 6},
    {28.070645, -16.704036, 59.3, 6},
    {28.070638, -16.704003, 59.6, 6},
    {28.070638, -16.704003, 59.6, 6},
    {28.070638, -16.704003, 59.6, 6},
    {28.070638, -16.704003, 59.6, 6},
    {28.070631, -16.703970, 65.8, 6},
    {28.070631, -16.703970, 65.8, 6},
    {28.070631, -16.703970, 65.8, 6},
    {28.070631, -16.703970, 65.8, 6},
    {28.070631, -16.703970, 65.8, 6},
    {28.070624, -16.703937, 65.1, 6},
    {28.070624, -16.703937, 70.1, 6},
    {28.070624, -16.703937, 70.1, 6},
    {28.070624, -16.703937, 70.1, 6},
    {28.070617, -16.703903, 70.4, 6},
    {28.070617, -16.703903, 60.4, 6},
    {28.070617, -16.703903, 60.4, 6},
    {28.070617, -16.703903, 60.4, 6},
    {28.070617, -16.703903, 60.4, 6},
    {28.070611, -16.703870, 60.3, 6},
    {28.070611, -16.703870, 60.3, 6},
    {28.070611, -16.703870, 60.3, 6},
    {28.070611, -16.703870, 60.3, 6},
    {28.070604, -16.703837, 60.4, 6},
    {28.070604, -16.703837, 60.4, 6},
    {28.070604, -16.703837, 60.4, 6},
    {28.070604, -16.703837, 60.4, 6},
    {28.070597, -16.703803, 60.8, 6},
    {28.070597, -16.703803, 60.8, 6},
    {28.070597, -16.703803, 60.8, 6},
    {28.070597, -16.703803, 60.8, 6},
    {28.070597, -16.703803, 60.8, 6},
    {28.070591, -16.703770, 60.7, 6},
    {28.070591, -16.703770, 60.7, 6},
    {28.070591, -16.703770, 60.7, 6},
};

static bool test_running = false;
static int test_step = 0;
static unsigned long test_last_update_ms = 0;

uint8_t test(bool bp_status, const double test_coords[][4])
{
    if (test_running == false && bp_status == true)
    {
        test_last_update_ms = millis();
        test_running = true;
    }
    else if (test_running == true && millis() - test_last_update_ms >= 500)
    {
        test_last_update_ms = millis();
        updateRadarAlerts(test_coords[test_step][0], test_coords[test_step][1], test_coords[test_step][2], test_coords[test_step][3]);
        test_step++;
        if (test_step >= 187)
        {
            test_step = 0;
            test_running = false;
            return 0;
        }
        char tmp[32];
        snprintf(tmp, sizeof(tmp), "test step: %d", test_step);
        showMessage(tmp, h / 2 - 14, ST77XX_WHITE, 1);
    }
    return 1;
}

static bool test_app_running = false;

void test_app()
{
    static uint8_t test_num = 0;

    if (test_app_running == false)
        return;

    /* switch (test_num)
    {
    case 0: */
    showMessage("Test 0: enter radar zone", h / 2 - 10, ST77XX_WHITE, 1);
    if (test(true, bp1_test_coords) == 0)
        test_num++;
}

void test_start()
{
    test_app_running = true;
    test_step = 0;
    test_running = false;
    test_last_update_ms = 0;
}

void test_stop()
{
    test_app_running = false;
}

void tests_init()
{
    // no-op for now
}
